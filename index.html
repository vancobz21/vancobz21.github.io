<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="title">Crayne Influence Counter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            height: 100vh;
            overflow: hidden;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .defeated-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(40, 10, 10, 0.6);
            color: #ff8a8a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(1px);
            -webkit-backdrop-filter: blur(1px);
            padding: 1rem;
            text-align: center;
            z-index: 30;
        }
        .setup-image-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
            max-width: 80%;
            height: auto;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            margin-left: auto;
            margin-right: auto;
        }
        .setup-image { width: 100%; height: auto; display: block; }
        #menu-container { 
            position: fixed; 
            top: 50%; 
            right: -1.4rem;
            transform: translateY(-50%); 
            z-index: 50;
            transition: right 0.2s ease-in-out;
        }
        #menu-container:hover {
            right: 0.5rem;
        }
        #menu-btn {
            padding: 0.5rem;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 9999px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, background-color 0.2s;
        }
        #menu-btn:hover { 
            transform: scale(1.05); 
            background-color: rgba(255, 255, 255, 0.7);
        }
        #menu-dropdown {
            position: absolute; bottom: 50%; right: 100%;
            transform: translateY(50%);
            width: 150px;
            margin-right: 0.75rem;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            overflow: hidden;
            opacity: 0;
            transform-origin: right center;
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            pointer-events: none;
        }
        #menu-dropdown.active { opacity: 1; transform: translateY(50%) scale(1); pointer-events: auto; }
        #menu-dropdown button { width: 100%; text-align: left; padding: 0.75rem 1rem; transition: background-color 0.2s; }
        #menu-dropdown button:hover { background-color: rgba(0, 0, 0, 0.05); }
        #turn-indicator-container {
            position: fixed;
            top: 50%;
            left: 1rem;
            transform: translateY(-50%);
            z-index: 40;
        }
        #random-result-box {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.5);
            padding: 2rem 4rem;
            background-color: rgba(255, 255, 255, 0.95);
            color: #333;
            border-radius: 2rem;
            font-size: 8rem;
            font-weight: 900;
            text-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            box-shadow: 0 20px 50px rgba(0,0,0,0.4);
            z-index: 60;
            opacity: 0;
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        #random-result-box.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .first-player-highlight {
            color: #FFD700 !important;
            text-shadow: -1.5px -1.5px 0 #fff, 1.5px -1.5px 0 #fff, -1.5px 1.5px 0 #fff, 1.5px 1.5px 0 #fff, 0 0 15px #FFD700;
        }
        .life-display {
            font-size: clamp(3rem, 20vmin, 10rem);
        }
        .damage-display {
            font-weight: 900;
            color: #f87171;
            text-shadow: 0 0 5px rgba(0,0,0,0.7);
        }
        @keyframes life-pop-fade {
            0% { transform: translate(-50%, 0) scale(0.9); opacity: 1; }
            66% { transform: translate(-50%, -20px) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -60px) scale(1.1); opacity: 0; }
        }
        .life-change-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            font-size: clamp(1.5rem, 8vmin, 3rem);
            font-weight: 700;
            pointer-events: none;
            z-index: 26;
            animation: life-pop-fade 1.5s ease-out forwards;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        .content-wrapper {
            transition: transform 0.3s ease-in-out;
            width: 100%;
            height: 100%;
            position: relative;
        }
        .block-label {
            font-weight: 600;
            font-size: 0.65rem;
            line-height: 1;
            text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center h-screen">

    <div id="setup-controls" class="bg-white p-4 rounded-2xl shadow-xl w-full max-w-4xl mx-auto text-center m-auto">
        <div class="flex justify-end mb-2">
            <select id="language-selector" class="p-1 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 transition-all duration-200 text-sm">
                <option value="th">ไทย</option>
                <option value="en" selected>English</option>
            </select>
        </div>
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2" data-lang-key="appTitle"></h1>
        <div class="setup-image-container">
            <img src="CrayneLogo.jpg" alt="Crayne Fractured Empire Logo" class="setup-image" onerror="this.onerror=null;this.src='https://placehold.co/600x300/e2e8f0/4a5568?text=Crayne+Logo';">
        </div>
        <div class="flex flex-col items-center justify-center">
             <div class="flex flex-col sm:flex-row items-center justify-center space-y-2 sm:space-y-0 sm:space-x-4">
                <div class="flex items-center space-x-2 w-full sm:w-auto">
                    <label for="player-count" class="text-md sm:text-lg font-semibold text-gray-700" data-lang-key="playerCountLabel"></label>
                    <select id="player-count" class="p-1 sm:p-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 transition-all duration-200">
                        <option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="6B">6 (B)</option>
                    </select>
                </div>
                <button id="start-btn" class="w-full sm:w-auto py-2 px-4 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-xl transition-colors duration-200 shadow-lg active:shadow-none active:translate-y-1 transform" data-lang-key="startButton"></button>
            </div>
            <div id="color-preview" class="mt-4 flex justify-center items-center space-x-2 h-8"></div>
        </div>
    </div>
    
    <div id="players-container" class="w-full h-full flex-grow grid min-h-0"></div>

    <div id="next-turn-container" class="hidden fixed inset-0 flex items-center justify-center z-30 pointer-events-none">
        <div class="flex items-center space-x-4 pointer-events-auto">
            <button id="undo-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold p-3 rounded-full shadow-lg transition-transform active:scale-90">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0019 16V8a1 1 0 00-1.6-.8l-5.333 4zM4.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0011 16V8a1 1 0 00-1.6-.8l-5.334 4z"></path></svg>
            </button>
            <button id="next-turn-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 px-8 rounded-full text-2xl shadow-lg" data-lang-key="next_turn_btn"></button>
        </div>
    </div>

    <div id="menu-container" class="hidden">
        <div class="relative">
            <button id="menu-btn" class="text-gray-600">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <div id="menu-dropdown" class="text-gray-800">
                <button id="restart-game-btn" data-lang-key="menuRestart"></button>
                <button id="toggle-fullscreen-btn" data-lang-key="menuFullscreen"></button>
                <button id="random-btn" data-lang-key="menuRandom"></button>
            </div>
        </div>
    </div>

    <div id="turn-indicator-container" class="hidden">
         <button id="turn-log-indicator" class="bg-gray-800 text-white text-xs font-bold w-8 h-8 rounded-full flex items-center justify-center border-2 border-white shadow-md">
            1
        </button>
    </div>

    <div id="random-result-box" class="hidden"></div>
    
    <div id="game-over-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4 cursor-pointer">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-sm w-full transform scale-100 transition-transform duration-300 cursor-default">
            <h2 class="text-4xl font-extrabold text-red-500 mb-4" data-lang-key="gameOverTitle"></h2>
            <p id="winner-message" class="text-xl font-bold text-gray-700 mb-6"></p>
            <button id="modal-reset-btn" class="py-3 px-6 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-xl transition-colors duration-200 shadow-lg active:shadow-none active:translate-y-1 transform" data-lang-key="newGameButton"></button>
        </div>
    </div>

    <div id="log-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-lg h-3/4 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800" data-lang-key="logTitle">Game Log</h2>
                <button id="close-log-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="log-content" class="flex-grow overflow-y-auto bg-gray-100 p-4 rounded-lg"></div>
        </div>
    </div>

    <p id="version-display" class="fixed bottom-2 right-3 text-xs text-gray-400 select-none z-10">v3.1.3-touch-fix</p>

    <script>
        // --- Constants & Config ---
        const STARTING_LIFE = { 2: 30, default: 60 };
        const CUSTOM_ORDERS = { 2: [1, 2], 3: [1, 2, 3], 4: [1, 2, 4, 3], 5: [1, 2, 3, 5, 4], 6: [1, 2, 3, 6, 5, 4] };
        const COMBAT_PAIRS_6B_PLAYER_PERSPECTIVE = { 1: { left: 3, right: 2 }, 2: { left: 1, right: 4 }, 3: { left: 5, right: 1 }, 4: { left: 2, right: 6 }, 5: { left: 6, right: 3 }, 6: { left: 4, right: 5 } };
        const COLOR_FAMILIES = [ [ { name: 'แดง', name_en: 'Red', tailwindClass: 'bg-red-600', textColorClass: 'text-red-600' }, { name: 'กุหลาบ', name_en: 'Rose', tailwindClass: 'bg-rose-500', textColorClass: 'text-rose-500' }, { name: 'ชมพู', name_en: 'Pink', tailwindClass: 'bg-pink-500', textColorClass: 'text-pink-500' }, ], [ { name: 'น้ำเงิน', name_en: 'Blue', tailwindClass: 'bg-blue-600', textColorClass: 'text-blue-600' }, { name: 'ท้องฟ้า', name_en: 'Sky', tailwindClass: 'bg-sky-500', textColorClass: 'text-sky-500' }, { name: 'คราม', name_en: 'Indigo', tailwindClass: 'bg-indigo-500', textColorClass: 'text-indigo-500' }, ], [ { name: 'เขียว', name_en: 'Green', tailwindClass: 'bg-green-600', textColorClass: 'text-green-600' }, { name: 'มรกต', name_en: 'Emerald', tailwindClass: 'bg-emerald-500', textColorClass: 'text-emerald-500' }, { name: 'ฟ้าอมเขียว', name_en: 'Teal', tailwindClass: 'bg-teal-500', textColorClass: 'text-teal-500' }, { name: 'เขียวมะนาว', name_en: 'Lime', tailwindClass: 'bg-lime-500', textColorClass: 'text-lime-500' }, ], [ { name: 'ม่วง', name_en: 'Purple', tailwindClass: 'bg-purple-600', textColorClass: 'text-purple-600' }, { name: 'ไวโอเล็ต', name_en: 'Violet', tailwindClass: 'bg-violet-600', textColorClass: 'text-violet-600' }, ], [ { name: 'เหลือง', name_en: 'Yellow', tailwindClass: 'bg-yellow-400', textColorClass: 'text-yellow-400' }, { name: 'เหลืองอำพัน', name_en: 'Amber', tailwindClass: 'bg-amber-500', textColorClass: 'text-amber-500' }, { name: 'ส้ม', name_en: 'Orange', tailwindClass: 'bg-orange-500', textColorClass: 'text-orange-500' }, ], [ { name: 'เทา', name_en: 'Slate', tailwindClass: 'bg-slate-500', textColorClass: 'text-slate-500' }, { name: 'ฟ้า', name_en: 'Cyan', tailwindClass: 'bg-cyan-500', textColorClass: 'text-cyan-500' }, ] ];
        const DEFEAT_TAUNTS = { th: [ "กำจัดจุดอ่อน!", "ก๊าาาาก ก า ก", "เล่นเพื่อการกุศล", "สมน้ำหน้า 555", "แค่นี้ก็ไม่รอด สัส", "ไปเกิดใหม่ไป๊", "ไหวป่ะเนี่ย?", "ง่วงหราา", "เพิ่มชีวิตอีกสักร้อยมะ?", "มันจ้าซะเหลือเกิน!!", "ไอ้สอง ให้พี่เดินสะดวกเถอะ", "นิ่มแบบนี้ คนหรือขี้วะ!", "ไปหวันซะละ", "รีบไปไหน แม่ใช้ไปซื้อน้ำปลาเหรอ", "อะเหื้อ!! ฝากลูกเมียข้าด้วย", "ไว้เจอกันใหม่นร้าา", "เธอคือที่หนึ่ง...จากท้าย", "นี่เล่นเอาฮาใช่ปะ?", "R I P", "ไปซักผ้า ดำน้ำ ดูปะการัง ฯฯ", "ไปนั่งสมาธิรอนะ", "เกมนี้ไม่เหมาะกับคนอ่อนแอ", "ขอน้ำใบบัวบกหน่อย", "ยืนเฉยๆ เขาก็ชนะ", "ค่าจ้างเท่าไหร่เนี่ย?", "เล่นเพื่อสุขภาพ", "บทน้อยจังวะ", "ตายอย่างสงบ ศพสีชมพู", "สวยงามตามท้องเรื่อง", "เกมพลิกว่ะ...พลิกลงหลุม" ], en: [ "Just a flesh wound.", "I've seen better plays in my soup.", "Were you trying?", "That was... an attempt.", "Error 404: Skill not found.", "Next time, try plugging in the controller.", "My grandma plays better.", "You're the reason for participation trophies.", "At least you tried. Or did you?", "I'm not mad, just disappointed.", "Task failed successfully.", "It's okay, we all have off-days.", "Maybe this isn't your game.", "A for effort, F for result.", "Did you lag?", "I'll send you a tutorial link.", "That's rough, buddy.", "You have been unsubscribed from life.", "GG EZ.", "Better luck next millennium." ] };
        const TRANSLATIONS = { 'th': { title: 'เครื่องนับ Influence Crayne', appTitle: 'เครื่องนับ Influence Crayne', playerCountLabel: 'จำนวนผู้เล่น:', startButton: 'เริ่มเกม', gameOverTitle: 'เกมจบแล้ว!', newGameButton: 'เริ่มเกมใหม่', ready: 'พร้อม', defeated: 'แพ้แล้ว', block: 'บล็อก', winnerMsg: (c) => `ผู้เล่น ${c} เป็นผู้ชนะ!`, noWinnerMsg: 'ไม่มีผู้ชนะ!', menuRestart: 'รีสตาร์ท', menuFullscreen: 'ขยายเต็มจอ', menuExitFullscreen: 'ย่อหน้าจอ', menuRandom: 'สุ่มเลข', next_turn_btn: 'เริ่มรอบถัดไป', logTitle: 'บันทึกเกม', logTurn: (t) => `เทิร์นที่ ${t}` }, 'en': { title: 'Crayne Influence Counter', appTitle: 'Crayne Influence Counter', playerCountLabel: 'Players:', startButton: 'Start Game', gameOverTitle: 'Game Over!', newGameButton: 'New Game', ready: 'Ready', defeated: 'Defeated', block: 'Block', winnerMsg: (c) => `Player ${c} wins!`, noWinnerMsg: 'No Winner!', menuRestart: 'Restart', menuFullscreen: 'Fullscreen', menuExitFullscreen: 'Exit Fullscreen', menuRandom: 'Random', next_turn_btn: 'Next Turn', logTitle: 'Game Log', logTurn: (t) => `Turn ${t}` } };

        // --- State Management ---
        const gameState = { players: [], initialPlayerCount: 0, layoutMode: null, firstPlayerId: null, currentLang: localStorage.getItem('appLang') || 'th', isBuyPhase: false, turnCount: 0, gameLog: [], previewColors: [], previousPlayerState: null };
        
        // --- UI Element Cache ---
        const ui = { playerCountSelector: document.getElementById('player-count'), playersContainer: document.getElementById('players-container'), startBtn: document.getElementById('start-btn'), setupControls: document.getElementById('setup-controls'), gameOverModal: document.getElementById('game-over-modal'), winnerMessage: document.getElementById('winner-message'), modalResetBtn: document.getElementById('modal-reset-btn'), languageSelector: document.getElementById('language-selector'), menuContainer: document.getElementById('menu-container'), menuBtn: document.getElementById('menu-btn'), menuDropdown: document.getElementById('menu-dropdown'), restartGameBtn: document.getElementById('restart-game-btn'), toggleFullscreenBtn: document.getElementById('toggle-fullscreen-btn'), randomBtn: document.getElementById('random-btn'), turnLogIndicator: document.getElementById('turn-log-indicator'), turnIndicatorContainer: document.getElementById('turn-indicator-container'), randomResultBox: document.getElementById('random-result-box'), versionDisplay: document.getElementById('version-display'), nextTurnContainer: document.getElementById('next-turn-container'), nextTurnBtn: document.getElementById('next-turn-btn'), undoBtn: document.getElementById('undo-btn'), logModal: document.getElementById('log-modal'), logContent: document.getElementById('log-content'), closeLogBtn: document.getElementById('close-log-btn'), colorPreview: document.getElementById('color-preview') };
        
        // --- Utility Functions ---
        const shuffleArray = (array) => { const newArr = [...array]; for (let i = newArr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [newArr[i], newArr[j]] = [newArr[j], newArr[i]]; } return newArr; };
        const goFullscreen = (orientation = 'landscape') => { const el = document.documentElement; if (el.requestFullscreen) el.requestFullscreen(); else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen(); if (screen.orientation && screen.orientation.lock) screen.orientation.lock(orientation).catch(() => {}); };

        // --- UI Rendering & Creation ---
        const renderAllCards = () => {
            gameState.players.forEach(p => updatePlayerCard(p));
        };

        const createPlayerCard = (player) => {
            const playerCard = document.createElement('div');
            playerCard.id = `player-card-${player.id}`;
            const contentHTML = gameState.layoutMode === '6B' ? createPlayerCard6B(player) : createPlayerCardStandard(player);
            playerCard.innerHTML = `<div class="content-wrapper">${contentHTML}<div class="defeated-overlay" style="display: none;"><span class="text-2xl font-extrabold" data-lang-key="defeated"></span><span class="taunt-text text-lg italic mt-2 text-red-300"></span></div></div>`;
            return playerCard;
        };
        
        const createPlayerCard6B = (player) => {
            return `
                <div class="relative w-full h-full flex items-center justify-center text-white p-1 overflow-hidden">
                    <!-- DUAL BLOCK UI (Top Row) -->
                    <div class="dual-block-ui absolute top-4 left-0 right-0 flex justify-around items-center z-20">
                        <div class="flex flex-col items-center"><div class="flex items-center"><button data-player-id="${player.id}" data-action="decrement-leftBlock" class="w-5 h-5 bg-white bg-opacity-30 rounded-full">-</button><span class="left-block-display text-2xl font-bold mx-1">0</span><button data-player-id="${player.id}" data-action="increment-leftBlock" class="w-5 h-5 bg-white bg-opacity-30 rounded-full">+</button></div><div class="left-opponent-indicator w-3 h-3 mt-1 rounded-full ring-2 ring-white"></div></div>
                        <button data-player-id="${player.id}" data-action="ready" class="ready-btn p-1 text-xs bg-white text-gray-800 font-semibold rounded-lg shadow-lg">Ready</button>
                        <div class="flex flex-col items-center"><div class="flex items-center"><button data-player-id="${player.id}" data-action="decrement-rightBlock" class="w-5 h-5 bg-white bg-opacity-30 rounded-full">-</button><span class="right-block-display text-2xl font-bold mx-1">0</span><button data-player-id="${player.id}" data-action="increment-rightBlock" class="w-5 h-5 bg-white bg-opacity-30 rounded-full">+</button></div><div class="right-opponent-indicator w-3 h-3 mt-1 rounded-full ring-2 ring-white"></div></div>
                    </div>
                    <!-- SINGLE BLOCK UI (Top Row) -->
                    <div class="single-block-ui hidden absolute top-4 left-0 right-0 flex justify-around items-center z-20">
                         <div class="flex flex-col items-center"><span class="text-xs" data-lang-key="block"></span><div class="flex items-center"><button data-player-id="${player.id}" data-action="decrement-block" class="w-5 h-5 bg-white bg-opacity-30 rounded-full">-</button><span class="block-display text-2xl font-bold mx-1">0</span><button data-player-id="${player.id}" data-action="increment-block" class="w-5 h-5 bg-white bg-opacity-30 rounded-full">+</button></div></div>
                         <button data-player-id="${player.id}" data-action="ready" class="ready-btn p-1 text-xs bg-white text-gray-800 font-semibold rounded-lg shadow-lg">Ready</button>
                    </div>
                    <!-- Middle Row: Life -->
                    <div class="flex items-center justify-center space-x-1 z-10">
                        <button data-player-id="${player.id}" data-action="decrement-life" class="w-8 h-8 flex items-center justify-center bg-red-500 bg-opacity-80 rounded-full text-2xl">-</button>
                        <div class="relative flex items-center justify-center"><div class="damage-container absolute left-0 -translate-x-full pr-2"></div><span class="life-display font-extrabold text-white text-5xl mx-1">60</span></div>
                        <button data-player-id="${player.id}" data-action="increment-life" class="w-8 h-8 flex items-center justify-center bg-green-500 bg-opacity-80 rounded-full text-2xl">+</button>
                    </div>
                    <!-- Bottom Row: ATK/DEF -->
                    <div class="absolute bottom-4 left-0 right-0 flex justify-around items-center z-10">
                        <div class="flex flex-col items-center"><span class="text-xs">ATK</span><div class="flex items-center"><button data-player-id="${player.id}" data-action="decrement-atk" class="w-5 h-5 bg-white bg-opacity-30 rounded-full">-</button><span class="atk-display text-4xl font-bold mx-1">0</span><button data-player-id="${player.id}" data-action="increment-atk" class="w-5 h-5 bg-white bg-opacity-30 rounded-full">+</button></div></div>
                        <div class="flex flex-col items-center"><span class="text-xs">DEF</span><div class="flex items-center"><button data-player-id="${player.id}" data-action="decrement-def" class="w-5 h-5 bg-white bg-opacity-30 rounded-full">-</button><span class="def-display text-4xl font-bold mx-1">0</span><button data-player-id="${player.id}" data-action="increment-def" class="w-5 h-5 bg-white bg-opacity-30 rounded-full">+</button></div></div>
                    </div>
                </div>`;
        };

        const createPlayerCardStandard = (player) => {
            const isTwoPlayerMode = gameState.initialPlayerCount === 2;
            const fontSizes = { stats: 'text-2xl sm:text-3xl md:text-4xl font-bold', block: 'text-xl sm:text-2xl font-bold', label: 'text-xs', readyBtn: 'p-2 text-sm', smallBtn: 'w-4 h-4 sm:w-5 sm:h-5', mediumBtn: 'w-5 h-5 sm:w-6 sm:h-6', largeBtn: 'w-7 h-7 sm:w-8 sm:h-8 text-xl' };
            if(isTwoPlayerMode) Object.assign(fontSizes, { stats: 'text-6xl font-bold', block: 'text-4xl font-bold', label: 'text-lg', readyBtn: 'p-3 text-lg', smallBtn: 'w-8 h-8', mediumBtn: 'w-10 h-10', largeBtn: 'w-10 h-10 text-3xl' });
            
            return `<div class="relative p-2 flex flex-col items-center justify-between h-full">
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-0"><span class="life-display font-extrabold text-white">60</span></div>
                <div class="relative z-10 w-full flex items-center justify-between">
                    <!-- DUAL BLOCK UI -->
                    <div class="dual-block-ui w-full flex items-center justify-between">
                        <div class="flex flex-col items-center flex-1"><div class="flex items-center"><span class="${fontSizes.label}" data-lang-key="block"></span><div class="left-opponent-indicator w-3 h-3 ml-1 rounded-full ring-2 ring-white"></div></div><div class="flex items-center mt-1"><button data-player-id="${player.id}" data-action="decrement-leftBlock" class="${fontSizes.smallBtn} bg-white bg-opacity-30 rounded-full">-</button><span class="left-block-display ${fontSizes.block}">0</span><button data-player-id="${player.id}" data-action="increment-leftBlock" class="${fontSizes.smallBtn} bg-white bg-opacity-30 rounded-full">+</button></div></div>
                        <div class="flex-shrink-0"><button data-player-id="${player.id}" data-action="ready" class="ready-btn ${fontSizes.readyBtn} bg-white text-gray-800 font-semibold rounded-xl shadow-lg">Ready</button></div>
                        <div class="flex flex-col items-center flex-1"><div class="flex items-center"><span class="${fontSizes.label}" data-lang-key="block"></span><div class="right-opponent-indicator w-3 h-3 ml-1 rounded-full ring-2 ring-white"></div></div><div class="flex items-center mt-1"><button data-player-id="${player.id}" data-action="decrement-rightBlock" class="${fontSizes.smallBtn} bg-white bg-opacity-30 rounded-full">-</button><span class="right-block-display ${fontSizes.block}">0</span><button data-player-id="${player.id}" data-action="increment-rightBlock" class="${fontSizes.smallBtn} bg-white bg-opacity-30 rounded-full">+</button></div></div>
                    </div>
                    <!-- SINGLE BLOCK UI -->
                    <div class="single-block-ui hidden w-full flex items-center justify-between">
                        <div class="flex-1"></div>
                        <div class="flex flex-col items-center flex-1"><span class="${fontSizes.label}" data-lang-key="block"></span><div class="flex items-center mt-1"><button data-player-id="${player.id}" data-action="decrement-block" class="${fontSizes.smallBtn} bg-white bg-opacity-30 rounded-full">-</button><span class="block-display ${fontSizes.block}">0</span><button data-player-id="${player.id}" data-action="increment-block" class="${fontSizes.smallBtn} bg-white bg-opacity-30 rounded-full">+</button></div></div>
                        <div class="flex-1 flex justify-center"><button data-player-id="${player.id}" data-action="ready" class="ready-btn ${fontSizes.readyBtn} bg-white text-gray-800 font-semibold rounded-xl shadow-lg">Ready</button></div>
                    </div>
                </div>
                <div class="relative z-10 flex-grow w-full flex items-center justify-between px-2"><button data-player-id="${player.id}" data-action="decrement-life" class="${fontSizes.largeBtn} flex items-center justify-center bg-red-500 bg-opacity-80 rounded-full">-</button><button data-player-id="${player.id}" data-action="increment-life" class="${fontSizes.largeBtn} flex items-center justify-center bg-green-500 bg-opacity-80 rounded-full">+</button></div>
                <div class="relative z-10 flex justify-center items-center space-x-2 w-full"><div class="flex flex-col items-center flex-1"><span class="${fontSizes.label}">ATK</span><div class="flex items-center"><button data-player-id="${player.id}" data-action="decrement-atk" class="${fontSizes.mediumBtn} bg-white bg-opacity-30 rounded-full">-</button><span class="atk-display ${fontSizes.stats}">0</span><button data-player-id="${player.id}" data-action="increment-atk" class="${fontSizes.mediumBtn} bg-white bg-opacity-30 rounded-full">+</button></div></div><div class="damage-container w-24"></div><div class="flex flex-col items-center flex-1"><span class="${fontSizes.label}">DEF</span><div class="flex items-center"><button data-player-id="${player.id}" data-action="decrement-def" class="${fontSizes.mediumBtn} bg-white bg-opacity-30 rounded-full">-</button><span class="def-display ${fontSizes.stats}">0</span><button data-player-id="${player.id}" data-action="increment-def" class="${fontSizes.mediumBtn} bg-white bg-opacity-30 rounded-full">+</button></div></div></div>
            </div>`;
        };
        
        const updatePlayerCard = (player) => {
            const card = document.getElementById(`player-card-${player.id}`);
            if (!card) return;
            _updateBlockVisibility(card);
            _updateCardLayout(card, player);
            _updateCardState(card, player);
            _updateCardData(card, player);
            _updateOpponentIndicators(card, player);
            _updateCardControls(card, player);
        };

        const _updateBlockVisibility = (card) => {
            const activePlayersCount = gameState.players.filter(p => !p.isDefeated).length;
            const singleBlockUI = card.querySelector('.single-block-ui');
            const dualBlockUI = card.querySelector('.dual-block-ui');
            if (!singleBlockUI || !dualBlockUI) return;
            const showSingle = activePlayersCount <= 2;
            singleBlockUI.classList.toggle('hidden', !showSingle);
            dualBlockUI.classList.toggle('hidden', showSingle);
        };

        const _updateCardLayout = (card, player) => {
            card.className = `${player.tailwindClass} text-white shadow-xl relative overflow-hidden flex`;
            if (gameState.layoutMode === '6B') {
                const positions = { 1: 'col-span-2 row-start-1', 2: 'col-start-1 row-start-2', 3: 'col-start-2 row-start-2', 4: 'col-start-1 row-start-3', 5: 'col-start-2 row-start-3', 6: 'col-span-2 row-start-4' };
                card.className += ` ${positions[player.id]}`;
            }
            const rotationClasses = { 1: 'rotate-180', 2: 'rotate-90', 3: '-rotate-90', 4: 'rotate-90', 5: '-rotate-90' };
            const rotation = (gameState.layoutMode === '6B' && rotationClasses[player.id]) || (gameState.layoutMode !== '6B' && (gameState.initialPlayerCount === 2 ? player.id === 1 : player.id <= Math.ceil(gameState.initialPlayerCount / 2)) ? 'rotate-180' : '');
            card.querySelector('.content-wrapper').style.transform = rotation ? `rotate(${rotation.replace('rotate-', '')}deg)` : '';
        };

        const _updateCardState = (card, player) => {
            const defeatedOverlay = card.querySelector('.defeated-overlay');
            if (player.isDefeated) {
                card.classList.add('opacity-40');
                defeatedOverlay.style.display = 'flex';
                defeatedOverlay.querySelector('.taunt-text').textContent = player.defeatTaunt || '';
            } else {
                card.classList.remove('opacity-40');
                defeatedOverlay.style.display = 'none';
            }
        };

        const _updateCardData = (card, player) => {
            card.querySelector('.life-display').textContent = player.life;
            card.querySelector('.life-display').classList.toggle('first-player-highlight', player.id === gameState.firstPlayerId && !player.isDefeated);
            card.querySelector('.atk-display').textContent = player.atk;
            card.querySelector('.def-display').textContent = player.def;
            const blockDisplay = card.querySelector('.block-display');
            if (blockDisplay) blockDisplay.textContent = player.block;
            const leftBlockDisplay = card.querySelector('.left-block-display');
            if(leftBlockDisplay) leftBlockDisplay.textContent = player.leftBlock;
            const rightBlockDisplay = card.querySelector('.right-block-display');
            if(rightBlockDisplay) rightBlockDisplay.textContent = player.rightBlock;
            const damageContainer = card.querySelector('.damage-container');
            const damageFontSize = gameState.layoutMode === '6B' ? 'text-5xl' : 'text-4xl';
            damageContainer.innerHTML = (player.lastDamageTaken > 0 && gameState.isBuyPhase) ? `<span class="damage-display ${damageFontSize} font-bold">-${player.lastDamageTaken}</span>` : '';
        };

        const _updateOpponentIndicators = (card, player) => {
            const activePlayers = gameState.players.filter(p => !p.isDefeated);
            if (activePlayers.length <= 2) {
                const leftIndicator = card.querySelector('.left-opponent-indicator');
                if (leftIndicator) leftIndicator.classList.add('hidden');
                const rightIndicator = card.querySelector('.right-opponent-indicator');
                if (rightIndicator) rightIndicator.classList.add('hidden');
                return;
            };

            const leftIndicator = card.querySelector('.left-opponent-indicator');
            if(leftIndicator) leftIndicator.classList.remove('hidden');
            const rightIndicator = card.querySelector('.right-opponent-indicator');
            if(rightIndicator) rightIndicator.classList.remove('hidden');

            let leftOpponent, rightOpponent;
            if (gameState.layoutMode === '6B') {
                const activePlayerIds = activePlayers.map(p => p.id);
                const actualLeftOpponentId = get6BActualOpponent(player.id, COMBAT_PAIRS_6B_PLAYER_PERSPECTIVE[player.id].left, activePlayerIds);
                const actualRightOpponentId = get6BActualOpponent(player.id, COMBAT_PAIRS_6B_PLAYER_PERSPECTIVE[player.id].right, activePlayerIds);
                leftOpponent = gameState.players.find(p => p.id === actualLeftOpponentId);
                rightOpponent = gameState.players.find(p => p.id === actualRightOpponentId);
            } else {
                const activePlayerOrder = CUSTOM_ORDERS[gameState.initialPlayerCount].filter(id => activePlayers.some(p => p.id === id));
                const currentPlayerIndex = activePlayerOrder.indexOf(player.id);
                if (currentPlayerIndex === -1) return;
                leftOpponent = gameState.players.find(p => p.id === activePlayerOrder[(currentPlayerIndex + 1) % activePlayerOrder.length]);
                rightOpponent = gameState.players.find(p => p.id === activePlayerOrder[(currentPlayerIndex - 1 + activePlayerOrder.length) % activePlayerOrder.length]);
            }
            
            if (leftIndicator) leftIndicator.className = `left-opponent-indicator w-3 h-3 ml-1 rounded-full ring-2 ring-white ${leftOpponent ? leftOpponent.tailwindClass : 'bg-transparent'}`;
            if (rightIndicator) rightIndicator.className = `right-opponent-indicator w-3 h-3 ml-1 rounded-full ring-2 ring-white ${rightOpponent ? rightOpponent.tailwindClass : 'bg-transparent'}`;
        };

        const _updateCardControls = (card, player) => {
            card.querySelectorAll('.ready-btn').forEach(readyBtn => {
                if(readyBtn) {
                    readyBtn.textContent = TRANSLATIONS[gameState.currentLang]['ready'];
                    readyBtn.classList.toggle('bg-green-500', player.isReady);
                    readyBtn.classList.toggle('text-white', player.isReady);
                    readyBtn.classList.toggle('bg-white', !player.isReady);
                    readyBtn.classList.toggle('text-gray-800', !player.isReady);
                    readyBtn.disabled = player.isDefeated || gameState.isBuyPhase;
                }
            });
            const shouldLock = player.isDefeated || player.isReady || gameState.isBuyPhase;
            card.querySelectorAll(`[data-action$="-atk"], [data-action$="-def"], [data-action*="Block"]`).forEach(btn => btn.disabled = shouldLock);
            card.querySelectorAll(`[data-action$="-life"]`).forEach(btn => btn.disabled = player.isDefeated);
        };

        const showLifeChangeIndicator = (playerId, totalChange) => {
            const card = document.getElementById(`player-card-${playerId}`);
            if (!card || totalChange === 0) return;
            let indicator = card.querySelector('.life-change-indicator');
            if (indicator) indicator.remove();
            indicator = document.createElement('div');
            indicator.className = 'life-change-indicator';
            indicator.textContent = `${totalChange > 0 ? '+' : ''}${totalChange}`;
            indicator.style.color = totalChange > 0 ? '#a7f3d0' : '#fecaca';
            const contentWrapper = card.querySelector('.content-wrapper > div');
            if (contentWrapper) {
                contentWrapper.appendChild(indicator);
                setTimeout(() => indicator.remove(), 1400);
            }
        };

        const setLanguage = (lang) => {
            gameState.currentLang = lang;
            localStorage.setItem('appLang', lang);
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                const translation = TRANSLATIONS[lang][key];
                if (translation && typeof translation === 'string') {
                    el.textContent = translation;
                }
            });
            if (gameState.players.length > 0) renderAllCards();
        };
        
        const logEvent = (message) => { gameState.gameLog.push(message); };
        const updateLogModal = () => { ui.logContent.innerHTML = gameState.gameLog.map(entry => `<p class="text-sm text-gray-600 mb-1">${entry}</p>`).join(''); ui.logContent.scrollTop = ui.logContent.scrollHeight; };

        const startGame = () => {
            gameState.layoutMode = ui.playerCountSelector.value;
            gameState.initialPlayerCount = parseInt(gameState.layoutMode);
            const orientation = gameState.initialPlayerCount === 2 || gameState.layoutMode === '6B' ? 'portrait-primary' : 'landscape';
            goFullscreen(orientation);
            initPlayers();
            ui.setupControls.classList.add('hidden');
            ui.menuContainer.classList.remove('hidden');
            ui.turnIndicatorContainer.classList.remove('hidden');
            ui.versionDisplay.classList.add('hidden');
        };

        const resetGame = () => {
            Object.assign(gameState, { players: [], initialPlayerCount: 0, layoutMode: null, firstPlayerId: null, isBuyPhase: false, turnCount: 0, gameLog: [], previewColors: [], previousPlayerState: null });
            ui.nextTurnContainer.classList.add('hidden');
            ui.playersContainer.innerHTML = '';
            ui.setupControls.classList.remove('hidden');
            ui.menuContainer.classList.add('hidden');
            ui.turnIndicatorContainer.classList.add('hidden');
            if (document.fullscreenElement) document.exitFullscreen();
            updateColorPreview();
            setLanguage(gameState.currentLang);
        };
        
        const initPlayers = () => {
            const startingLife = STARTING_LIFE[gameState.initialPlayerCount] || STARTING_LIFE.default;
            gameState.players = Array.from({ length: gameState.initialPlayerCount }, (_, i) => ({ id: i + 1, ...gameState.previewColors[i], life: startingLife, atk: 0, def: 0, leftBlock: 0, rightBlock: 0, block: 0, isReady: false, isDefeated: false, lastDamageTaken: 0, manualLifeChange: 0, defeatTaunt: null }));
            if (gameState.players.length > 0) gameState.firstPlayerId = gameState.players[Math.floor(Math.random() * gameState.players.length)].id;
            gameState.turnCount = 1;
            ui.turnLogIndicator.textContent = gameState.turnCount;
            gameState.gameLog = [];
            logEvent(`<strong>Game Started with ${gameState.initialPlayerCount} players.</strong>`);
            logEvent(`<strong>--- ${TRANSLATIONS[gameState.currentLang].logTurn(gameState.turnCount)} ---</strong>`);
            ui.playersContainer.innerHTML = '';
            ui.playersContainer.style.gridTemplateRows = '';
            ui.playersContainer.className = 'w-full h-full flex-grow grid min-h-0';
            if (gameState.layoutMode === '6B') {
                ui.playersContainer.classList.add('grid-cols-2', 'grid-rows-4', 'gap-1');
                ui.playersContainer.style.gridTemplateRows = '1fr 1.5fr 1.5fr 1fr';
            } else {
                let gridClass = 'grid-cols-2';
                if (gameState.initialPlayerCount <= 2) gridClass = 'grid-cols-1';
                if (gameState.initialPlayerCount === 3) gridClass = 'grid-cols-2';
                if (gameState.initialPlayerCount >= 5) gridClass = 'grid-cols-2 md:grid-cols-3';
                ui.playersContainer.classList.add(...gridClass.split(' '));
            }
            gameState.players.forEach((player) => {
                const playerCard = createPlayerCard(player);
                if (gameState.layoutMode !== '6B' && gameState.initialPlayerCount === 3 && player.id === 3) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'col-span-full flex justify-center';
                    wrapper.appendChild(playerCard);
                    ui.playersContainer.appendChild(wrapper);
                } else {
                    ui.playersContainer.appendChild(playerCard);
                }
            });
             if (gameState.layoutMode !== '6B' && gameState.initialPlayerCount === 5) {
                const placeholder = document.createElement('div');
                placeholder.className = 'hidden md:block md:col-start-1';
                ui.playersContainer.insertBefore(placeholder, ui.playersContainer.children[3]);
            }
            renderAllCards();
        };

        const get6BActualOpponent = (startPlayerId, initialOpponentId, activePlayerIds) => {
            let currentOpponentId = initialOpponentId;
            let path = [startPlayerId];
            while (currentOpponentId && !activePlayerIds.includes(currentOpponentId)) {
                path.push(currentOpponentId);
                const defeatedId = currentOpponentId;
                const connections = [ COMBAT_PAIRS_6B_PLAYER_PERSPECTIVE[defeatedId].left, COMBAT_PAIRS_6B_PLAYER_PERSPECTIVE[defeatedId].right ];
                currentOpponentId = connections.find(id => !path.includes(id));
                if (path.length > 7) return null;
            }
            return currentOpponentId;
        };

        const applyDamage = () => {
            const activePlayers = gameState.players.filter(p => !p.isDefeated);
            if (activePlayers.length < 2) return [];
            
            activePlayers.forEach(p => p.lastDamageTaken = 0);
            const damageTaken = gameState.players.reduce((acc, p) => ({ ...acc, [p.id]: 0 }), {});
            
            if (activePlayers.length === 2) {
                const [p1, p2] = activePlayers;
                damageTaken[p2.id] += Math.max(0, p1.atk - p2.block);
                damageTaken[p1.id] += Math.max(0, p2.atk - p1.block);
            } else if (gameState.layoutMode === '6B') {
                const activePlayerIds = activePlayers.map(p => p.id);
                activePlayers.forEach(attacker => {
                    const actualLeftOpponentId = get6BActualOpponent(attacker.id, COMBAT_PAIRS_6B_PLAYER_PERSPECTIVE[attacker.id].left, activePlayerIds);
                    const actualRightOpponentId = get6BActualOpponent(attacker.id, COMBAT_PAIRS_6B_PLAYER_PERSPECTIVE[attacker.id].right, activePlayerIds);
                    const leftTarget = gameState.players.find(p => p.id === actualLeftOpponentId);
                    const rightTarget = gameState.players.find(p => p.id === actualRightOpponentId);
                    if (leftTarget) damageTaken[leftTarget.id] += Math.max(0, attacker.atk - leftTarget.rightBlock);
                    if (rightTarget) damageTaken[rightTarget.id] += Math.max(0, attacker.atk - rightTarget.leftBlock);
                });
            } else {
                const activePlayerOrder = CUSTOM_ORDERS[gameState.initialPlayerCount].filter(id => activePlayers.some(p => p.id === id));
                activePlayerOrder.forEach((attackerId, index) => {
                    const attacker = gameState.players.find(p => p.id === attackerId);
                    const leftDefender = gameState.players.find(p => p.id === activePlayerOrder[(index + 1) % activePlayerOrder.length]);
                    const rightDefender = gameState.players.find(p => p.id === activePlayerOrder[(index - 1 + activePlayerOrder.length) % activePlayerOrder.length]);
                    if (leftDefender) damageTaken[leftDefender.id] += Math.max(0, attacker.atk - leftDefender.rightBlock);
                    if (rightDefender) damageTaken[rightDefender.id] += Math.max(0, attacker.atk - rightDefender.leftBlock);
                });
            }

            const newlyDefeatedPlayers = [];
            activePlayers.forEach(p => {
                const finalDamage = Math.max(0, damageTaken[p.id] - p.def);
                if (finalDamage > 0) {
                    p.lastDamageTaken = finalDamage;
                    p.life -= finalDamage;
                    if (p.life <= 0 && !p.isDefeated) newlyDefeatedPlayers.push(p);
                }
            });
            return newlyDefeatedPlayers;
        };
        
        const checkGameOver = (newlyDefeatedPlayers) => {
            if (newlyDefeatedPlayers.length > 0) {
                newlyDefeatedPlayers.forEach(p => {
                    p.isDefeated = true;
                    const taunts = DEFEAT_TAUNTS[gameState.currentLang];
                    p.defeatTaunt = `"${taunts[Math.floor(Math.random() * taunts.length)]}"`;
                });
            }
            const remainingPlayers = gameState.players.filter(p => !p.isDefeated);
            let winner = null;
            let isGameOver = false;
            if (remainingPlayers.length === 1) {
                winner = remainingPlayers[0];
                isGameOver = true;
            } else if (remainingPlayers.length === 0) {
                 isGameOver = true;
                 const finalStandings = newlyDefeatedPlayers.slice().sort((a, b) => b.life - a.life);
                 if (finalStandings.length > 1 && finalStandings[0].life === finalStandings[1].life) {
                    winner = null;
                 } else {
                    winner = finalStandings[0];
                 }
            }
            if (isGameOver) {
                ui.gameOverModal.classList.remove('hidden');
                const t = (key, arg) => TRANSLATIONS[gameState.currentLang][key](arg);
                if (winner) {
                    ui.winnerMessage.textContent = t('winnerMsg', gameState.currentLang === 'en' ? winner.name_en : winner.name);
                    ui.winnerMessage.className = `text-xl font-bold ${winner.textColorClass} mb-6`;
                } else {
                    ui.winnerMessage.textContent = t('noWinnerMsg');
                    ui.winnerMessage.className = `text-xl font-bold text-gray-700 mb-6`;
                }
            }
            return isGameOver;
        };

        const passFirstPlayerToken = () => {
            const order = (gameState.layoutMode === '6B' ? Object.keys(COMBAT_PAIRS_6B_PLAYER_PERSPECTIVE).map(Number) : CUSTOM_ORDERS[gameState.initialPlayerCount]) || [];
            const activePlayers = gameState.players.filter(p => !p.isDefeated);
            if (order.length === 0 || !gameState.firstPlayerId || activePlayers.length < 2) {
                gameState.firstPlayerId = activePlayers.length > 0 ? activePlayers[0]?.id : null; return;
            };
            const startIndex = order.indexOf(gameState.firstPlayerId);
            if (startIndex === -1) { gameState.firstPlayerId = activePlayers[0]?.id; return; }
            for (let i = 1; i <= order.length; i++) {
                const nextPlayerId = order[(startIndex + i) % order.length];
                if (activePlayers.some(p => p.id === nextPlayerId)) { gameState.firstPlayerId = nextPlayerId; return; }
            }
            gameState.firstPlayerId = activePlayers[0]?.id;
        };

        const resetPlayerTurnStats = () => { gameState.players.forEach(p => { if (!p.isDefeated) Object.assign(p, { atk: 0, def: 0, leftBlock: 0, rightBlock: 0, block: 0, isReady: false, lastDamageTaken: 0, manualLifeChange: 0 }); }); };
        
        const handleRoundEnd = () => { 
            gameState.previousPlayerState = JSON.parse(JSON.stringify(gameState.players)); 
            const lifeBeforeDamage = gameState.players.map(p => ({ id: p.id, life: p.life, manualLifeChange: p.manualLifeChange }));
            const activePlayers = gameState.players.filter(p => !p.isDefeated);
            logEvent(`<strong>--- Combat Phase ---</strong>`);
            const newlyDefeated = applyDamage(); 
            gameState.isBuyPhase = true; 
            activePlayers.forEach(p => {
                const lifeData = lifeBeforeDamage.find(data => data.id === p.id);
                const manualChangeStr = lifeData.manualLifeChange !== 0 ? ` (${lifeData.manualLifeChange > 0 ? '+' : ''}${lifeData.manualLifeChange})` : '';
                let logStr = `- <span class="${p.textColorClass}">P${p.id}</span> | Life:${lifeData.life}${manualChangeStr} | ATK:${p.atk} DEF:${p.def}`;
                if (activePlayers.length > 2) {
                    logStr += `, L.Block:${p.leftBlock}, R.Block:${p.rightBlock}`;
                } else {
                    logStr += `, Block:${p.block}`;
                }
                if (p.lastDamageTaken > 0) {
                    logStr += ` | Took: ${p.lastDamageTaken} DMG > New Life: ${p.life}`;
                }
                logEvent(logStr);
            });
            if (newlyDefeated.length > 0) newlyDefeated.forEach(p => logEvent(`- <strong><span class="${p.textColorClass}">P${p.id}</span> has been defeated.</strong>`));
            const isGameOver = checkGameOver(newlyDefeated); 
            renderAllCards();
            if (!isGameOver) ui.nextTurnContainer.classList.remove('hidden');
        };
        
        const startNextTurn = () => { 
            gameState.previousPlayerState = null; 
            gameState.isBuyPhase = false; 
            ui.nextTurnContainer.classList.add('hidden'); 
            passFirstPlayerToken(); 
            resetPlayerTurnStats(); 
            gameState.turnCount++; 
            ui.turnLogIndicator.textContent = gameState.turnCount; 
            logEvent(`<strong>--- ${TRANSLATIONS[gameState.currentLang].logTurn(gameState.turnCount)} ---</strong>`);
            renderAllCards();
        };

        const handleUndo = () => { if (!gameState.previousPlayerState) return; gameState.players = JSON.parse(JSON.stringify(gameState.previousPlayerState)); gameState.isBuyPhase = false; gameState.previousPlayerState = null; ui.nextTurnContainer.classList.add('hidden'); renderAllCards(); };
        const checkAllReady = () => { const activePlayers = gameState.players.filter(p => !p.isDefeated); if (activePlayers.length > 0 && activePlayers.every(p => p.isReady)) handleRoundEnd(); };

        const performPlayerAction = (playerId, action) => {
            const player = gameState.players.find(p => p.id === playerId);
            if (!player || player.isDefeated) return;
            if ((player.isReady || gameState.isBuyPhase) && !['ready', 'increment-life', 'decrement-life'].includes(action)) return;
            if (action === 'ready') { 
                player.isReady = !player.isReady; 
                checkAllReady();
            } else {
                const [operation, property] = action.split('-');
                if (property in player) {
                    const value = operation === 'increment' ? 1 : -1;
                    const oldLife = player.life;
                    player[property] += value;
                    if (property === 'life') { 
                        player.manualLifeChange += value; 
                        showLifeChangeIndicator(player.id, player.manualLifeChange);
                        if(gameState.isBuyPhase) logEvent(`- <span class="${player.textColorClass}">P${player.id}</span>'s life changed: ${oldLife} -> ${player.life}.`);
                    }
                    if (!property.toLowerCase().includes('life')) player[property] = Math.max(0, player[property]);
                }
            }
            updatePlayerCard(player);
        };

        const handlePlayerInteraction = (event) => {
            event.preventDefault();
            const touch = event.changedTouches ? event.changedTouches[0] : event;
            const targetElement = document.elementFromPoint(touch.clientX, touch.clientY);
            const button = targetElement ? targetElement.closest('button[data-action]') : null;
            if (button) performPlayerAction(parseInt(button.dataset.playerId), button.dataset.action);
        };

        const showRandomNumber = () => {
            if (gameState.initialPlayerCount === 0) return;
            const maxRange = gameState.initialPlayerCount + 3;
            const randomNumber = Math.floor(Math.random() * maxRange) + 1;
            ui.randomResultBox.textContent = randomNumber;
            ui.randomResultBox.classList.remove('hidden');
            ui.randomResultBox.classList.add('show');
            setTimeout(() => {
                ui.randomResultBox.classList.remove('show');
                setTimeout(() => ui.randomResultBox.classList.add('hidden'), 500);
            }, 1500);
        };

        const updateColorPreview = () => {
            const count = parseInt(ui.playerCountSelector.value);
            const shuffledFamilies = shuffleArray(COLOR_FAMILIES);
            const selectedFamilies = shuffledFamilies.slice(0, count);
            gameState.previewColors = selectedFamilies.map(family => family[Math.floor(Math.random() * family.length)]);
            ui.colorPreview.innerHTML = gameState.previewColors.map(color => `<div class="w-6 h-6 rounded-full shadow-md transition-all duration-300 ${color.tailwindClass}"></div>`).join('');
        };
        
        const setupEventListeners = () => {
            ui.startBtn.addEventListener('click', startGame);
            ui.modalResetBtn.addEventListener('click', (e) => { e.stopPropagation(); resetGame(); ui.gameOverModal.classList.add('hidden'); });
            ui.gameOverModal.addEventListener('click', (event) => { if (event.target === ui.gameOverModal) ui.gameOverModal.classList.add('hidden'); });
            ui.turnLogIndicator.addEventListener('click', () => { updateLogModal(); ui.logModal.classList.remove('hidden'); });
            ui.closeLogBtn.addEventListener('click', () => ui.logModal.classList.add('hidden'));
            ui.playersContainer.addEventListener('touchstart', handlePlayerInteraction, { passive: false });
            ui.playersContainer.addEventListener('click', handlePlayerInteraction);
            ui.menuBtn.addEventListener('click', () => ui.menuDropdown.classList.toggle('active'));
            ui.restartGameBtn.addEventListener('click', resetGame);
            ui.randomBtn.addEventListener('click', showRandomNumber);
            ui.nextTurnBtn.addEventListener('click', startNextTurn);
            ui.undoBtn.addEventListener('click', handleUndo);
            ui.toggleFullscreenBtn.addEventListener('click', () => { if (!document.fullscreenElement) { const o = gameState.initialPlayerCount === 2 || gameState.layoutMode === '6B' ? 'portrait-primary' : 'landscape'; goFullscreen(o); } else if (document.exitFullscreen) document.exitFullscreen(); });
            ui.languageSelector.addEventListener('change', (event) => setLanguage(event.target.value));
            ui.playerCountSelector.addEventListener('change', updateColorPreview);

            // --- Menu Auto-Close Listeners ---
            const closeMenuHandler = (event) => {
                if (ui.menuDropdown.classList.contains('active') && !ui.menuContainer.contains(event.target)) {
                    ui.menuDropdown.classList.remove('active');
                }
            };
            document.addEventListener('click', closeMenuHandler);
            document.addEventListener('touchstart', closeMenuHandler);

            ui.menuDropdown.addEventListener('click', (event) => {
                if (event.target.tagName === 'BUTTON') {
                    ui.menuDropdown.classList.remove('active');
                }
            });
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            setLanguage(gameState.currentLang);
            updateColorPreview();
            setupEventListeners();
        });
    </script>
</body>
</html>
